{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h1>Connection Feed</h1>
    <ul class="list-group" id="event-list">
        {% for event in webhook_events %}
        <li class="list-group-item">
            <strong>{{ event.ticket_id }}</strong> - {{ event.event_status }} - Received at {{ event.received_at }}
        </li>
        {% endfor %}
    </ul>
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% for i in range(1, total // per_page + 1) %}
            <li class="page-item"><a class="page-link" href="{{ url_for('main.home', page=i) }}">{{ i }}</a></li>
            {% endfor %}
        </ul>
    </nav>
</div>
{% endblock content %}
{% block script %}
<script>
    let lastEventId = {{ webhook_events[0].id if webhook_events|length > 0 else 'null' }};
    
    function addEvent(event) {
        if (event.id <= lastEventId) {
            return;
        }

        const eventList = document.getElementById("event-list");
        const newItem = document.createElement("li");
        newItem.className = "list-group-item";
        newItem.innerHTML = `<strong>${event.ticket_id}</strong> - ${event.event_status} - Received at ${event.received_at}`;
        eventList.appendChild(newItem);

        lastEventId = event.id;
    }

    const eventSource = new EventSource("{{ url_for('main.sse_feed', last_event_id=lastEventId) }}");

    eventSource.onmessage = (event) => {
        const eventData = JSON.parse(event.data);
        addEvent(eventData);
    };
</script>
{% endblock script %}
